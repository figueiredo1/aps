teste
teste <- dt_emendas[, sum(valor_empenhado), by = id_municipio]
View(teste)
dt_emendas_total <- dt_emendas[, valor_empenhado2 = sum(valor_empenhado), by = id_municipio]
teste <- dt_emendas[, .(valor_empenhado = sum(valor_empenhado)), by = id_municipio]
# DESCOBRIR PQ NÃO TÁ DANDO CERTO
dt_emendas_total <- dt_emendas[,
.(valor_empenhado = sum(valor_empenhado)),
by = id_municipio]
library(readxl) # para obtenção dos dados
library(basedosdados) # para obtenção dos dados
library(dplyr) # para transformação dos dados
library(data.table) # para transformação dos dados
library(janitor) # para transformação dos dados
library(ggplot2) # para visualização dos dados
# Carregar planilha montada a partir dos relatórios do IBGE Cidades
dt_municipios <- read_excel("Bases de dados/informacoes_municipios.xlsx")
setDT(dt_municipios)
# Renomear colunas
nomes <- c("id_municipio_nome", "sigla_uf", "IDHm", "PIBpc", "percentual_renda_pc_meio_sm", "taxa_escolarizacao", "pop", "densidade_demografica")
colnames(dt_municipios) <- nomes
rm(nomes)
# Transformar gentílico na sigla do UF
dt_municipios[, sigla_uf := fcase(
sigla_uf == "alagoano", "AL",
sigla_uf == "baiano", "BA",
sigla_uf == "cearense", "CE",
sigla_uf == "maranhense", "MA",
sigla_uf == "paraibano", "PB",
sigla_uf == "pernambucano", "PE",
sigla_uf == "piauiense", "PI",
sigla_uf == "potiguar, norte-rio-grandense, rio-grandense-do-norte", "RN",
sigla_uf == "sergipano ou sergipense", "SE"
)]
# Transformar pop e densidade demográfica em variáveis numéricas
dt_municipios[, pop := gsub("[^0-9.-]", "", pop) %>% as.numeric()]
dt_municipios[,
densidade_demografica := as.numeric(
gsub(",", ".", gsub("[^0-9,]", "", densidade_demografica))
)
]
# Fazer query
# query <- "SELECT
#     dados.ano AS ano,
#     dados.turno AS turno,
#     dados.sigla_uf AS sigla_uf,
#     diretorio_sigla_uf.nome AS sigla_uf_nome,
#     dados.id_municipio AS id_municipio,
#     diretorio_id_municipio.nome AS id_municipio_nome,
#     dados.cargo AS cargo,
#     dados.numero_partido AS numero_partido,
#     dados.sigla_partido AS sigla_partido,
#     dados.resultado AS resultado,
#     dados.votos AS votos
# FROM `basedosdados.br_tse_eleicoes.resultados_candidato_municipio` AS dados
# LEFT JOIN (
#     SELECT DISTINCT sigla, nome
#     FROM `basedosdados.br_bd_diretorios_brasil.uf`
# ) AS diretorio_sigla_uf
#     ON dados.sigla_uf = diretorio_sigla_uf.sigla
# LEFT JOIN (
#     SELECT DISTINCT id_municipio, nome
#     FROM `basedosdados.br_bd_diretorios_brasil.municipio`
# ) AS diretorio_id_municipio
#     ON dados.id_municipio = diretorio_id_municipio.id_municipio
# WHERE
#     dados.ano IN (2020)
#     AND dados.cargo = "prefeito"
#     AND CAST(dados.id_municipio AS STRING) LIKE "2%"
# "
# dt_eleicoes <- read_sql(query, billing_project_id = "pub-450900")
# setDT(dt_eleicoes)
# rm(query)
# Salvar base de dados resultante
# saveRDS(dt_eleicoes, "Bases de dados/informacoes_eleicoes.rds")
# Carregar base de dados de eleições
dt_eleicoes <- readRDS("Bases de dados/informacoes_eleicoes.rds")
setDT(dt_eleicoes)
# Retirar primeiro turno dos municípios que tiveram segundo turno
municipios_com_segundo_turno <- dt_eleicoes[turno == 2, unique(id_municipio)]
dt_eleicoes <- dt_eleicoes[!(turno == 1 &
id_municipio %in% municipios_com_segundo_turno)]
rm(municipios_com_segundo_turno)
# Selecionar os dois candidatos mais votados
setorder(dt_eleicoes, -votos)
dt_eleicoes <- dt_eleicoes[, head(.SD, 2), by = id_municipio]
# Definir razão de votos dos top 2 (contando somente os votos desses 2)
dt_eleicoes[, votos_total := sum(votos), by = id_municipio]
dt_eleicoes[, votos_razao := votos/votos_total]
# Retirar municípios em que nenhum dos dois primeiros colocados são do PP
municipios_com_candidato_pp <- dt_eleicoes[sigla_partido == "PP", unique(id_municipio)]
dt_eleicoes <- dt_eleicoes[id_municipio %in% municipios_com_candidato_pp]
rm(municipios_com_candidato_pp)
# Selecionar municípios em que a margem de vitória foi de 5% ou menos
dt_eleicoes <- dt_eleicoes[votos_razao >= 0.45 & votos_razao <= 0.55]
# Criar dummy que indica se o candidato do PP ganhou
municipios_com_vitoria_pp <- dt_eleicoes[sigla_partido == "PP" & resultado == "eleito",
unique(id_municipio)]
dt_eleicoes[, vitoria_pp := ifelse(id_municipio %in% municipios_com_vitoria_pp, 1, 0)]
rm(municipios_com_vitoria_pp)
# Selecionar só colunas e linhas relevantes
dt_eleicoes <- dt_eleicoes[
sigla_partido == "PP",
.(
id_municipio,
id_municipio_nome,
sigla_uf,
votos_razao,
vitoria_pp
)
]
setnames(dt_eleicoes, "votos_razao", "votos_razao_pp")
# Dar uma olhada na base de dados resultante
str(dt_eleicoes)
# Carregar base de dados de emendas parlamentares
dt_emendas <- read.csv2("Bases de dados/EmendasParlamentares.csv", fileEncoding = "Latin1", encoding = "UTF-8")
setDT(dt_emendas)
# Renomear colunas
colnames(dt_emendas) <- make_clean_names(colnames(dt_emendas))
setnames(dt_emendas, "codigo_municipio_ibge", "id_municipio")
# Selecionar dados relevantes
dt_emendas <- dt_emendas[
ano_da_emenda == 2021 & regiao == "Nordeste" & id_municipio != "Sem informação",
.(
ano_da_emenda,
tipo_de_emenda,
id_municipio,
valor_empenhado
)
]
# Ver quais tipos de emendas restam
dt_emendas[, unique(tipo_de_emenda)]
# Simplificar nome do tipo de emenda
dt_emendas[, tipo_de_emenda := fcase(
tipo_de_emenda == "Emenda Individual - Transferências com Finalidade Definida", "individual - finalidade definida",
tipo_de_emenda == "Emenda Individual - Transferências Especiais", "individual - 'pix'",
tipo_de_emenda == "Emenda de Bancada", "bancada",
tipo_de_emenda == "Emenda de Comissão", "comissão"
)]
# Agregar valor empenhado por ano, tipo de emenda e município
dt_emendas <- dt_emendas[, valor_empenhado := sum(valor_empenhado),
by = .(tipo_de_emenda, id_municipio)]
# Ver se algum município de dt_eleicoes não está em dt_municípios
municipios_dt_eleicoes <- unique(dt_eleicoes[, paste0(id_municipio_nome, sigla_uf)])
municipios_dt_municipios <- unique(dt_municipios[, paste0(id_municipio_nome, sigla_uf)])
for (muni in municipios_dt_eleicoes) {
if (!muni %in% municipios_dt_municipios) {
print(muni)
}
}
rm(municipios_dt_eleicoes, municipios_dt_municipios, muni)
# Renomear municípios de dt_municipios fora do padrão de dt_eleicoes
dt_municipios[id_municipio_nome == "Santa Terezinha" & sigla_uf == "BA",
id_municipio_nome := "Santa Teresinha"]
# Adicionar dados sobre os municípios com eleições de interesse
dt_municipios_eleicoes <- merge(dt_eleicoes, dt_municipios, all.x = T)
## Verificar se houve algum NA
colSums(is.na(dt_municipios_eleicoes))
# Criar dt com médias
medias_municipios_eleicoes <- dt_municipios_eleicoes[
,
.(
media_IDHm = mean(IDHm),
media_PIBpc = mean(PIBpc),
media_percentual_renda_pc_meio_sm = mean(percentual_renda_pc_meio_sm),
media_taxa_escolarizacao = mean(taxa_escolarizacao),
media_pop = mean(pop),
media_densidade_demografica = mean(densidade_demografica)
),
by = vitoria_pp
]
# Plotar médias de quem venceu vs. não venceu - formatar
medias_municipios_eleicoes %>%
ggplot(aes(y = media_IDHm, x = as.factor(vitoria_pp))) +
geom_col() +
theme_minimal()
medias_municipios_eleicoes %>%
ggplot(aes(y = media_PIBpc, x = as.factor(vitoria_pp))) +
geom_col() +
theme_minimal()
medias_municipios_eleicoes %>%
ggplot(aes(y = media_percentual_renda_pc_meio_sm, x = as.factor(vitoria_pp))) +
geom_col() +
theme_minimal()
medias_municipios_eleicoes %>%
ggplot(aes(y = media_taxa_escolarizacao, x = as.factor(vitoria_pp))) +
geom_col() +
theme_minimal()
medias_municipios_eleicoes %>%
ggplot(aes(y = media_pop, x = as.factor(vitoria_pp))) +
geom_col() +
theme_minimal()
medias_municipios_eleicoes %>%
ggplot(aes(y = media_densidade_demografica, x = as.factor(vitoria_pp))) +
geom_col() +
theme_minimal()
# Mostrar quais diferenças são estatisticamente significantes - fazer teste de comparação de médias
# Criar dt com médias
medianas_municipios_eleicoes <- dt_municipios_eleicoes[
,
.(
mediana_IDHm = median(IDHm),
mediana_PIBpc = median(PIBpc),
mediana_percentual_renda_pc_meio_sm = median(percentual_renda_pc_meio_sm),
mediana_taxa_escolarizacao = median(taxa_escolarizacao),
mediana_pop = median(pop),
mediana_densidade_demografica = median(densidade_demografica)
),
by = vitoria_pp
]
# Plotar médias de quem venceu vs. não venceu - formatar
medianas_municipios_eleicoes %>%
ggplot(aes(y = mediana_IDHm, x = as.factor(vitoria_pp))) +
geom_col() +
theme_minimal()
medianas_municipios_eleicoes %>%
ggplot(aes(y = mediana_PIBpc, x = as.factor(vitoria_pp))) +
geom_col() +
theme_minimal()
medianas_municipios_eleicoes %>%
ggplot(aes(y = mediana_percentual_renda_pc_meio_sm, x = as.factor(vitoria_pp))) +
geom_col() +
theme_minimal()
medianas_municipios_eleicoes %>%
ggplot(aes(y = mediana_taxa_escolarizacao, x = as.factor(vitoria_pp))) +
geom_col() +
theme_minimal()
medianas_municipios_eleicoes %>%
ggplot(aes(y = mediana_pop, x = as.factor(vitoria_pp))) +
geom_col() +
theme_minimal()
medianas_municipios_eleicoes %>%
ggplot(aes(y = mediana_densidade_demografica, x = as.factor(vitoria_pp))) +
geom_col() +
theme_minimal()
# Mostrar quais diferenças são estatisticamente significantes - fazer teste de comparação de médias
dt_emendas[, unique(id_municipio)]
length(dt_emendas[, unique(id_municipio)])
## Juntar bases de dados
dt <- merge(dt_municipios_eleicoes, dt_emendas_todas, by = "id_municipio", all.x = T)
## Verificar se houve algum NA
colSums(is.na(dt))
## Juntar bases de dados
dt <- merge(dt_municipios_eleicoes, dt_emendas_total, by = "id_municipio", all.x = T)
## Preencher valores NA com 0
## Verificar se houve algum NA
colSums(is.na(dt))
View(dt)
View(dt_emendas_total)
rm(list = ls())
library(readxl) # para obtenção dos dados
library(basedosdados) # para obtenção dos dados
library(dplyr) # para transformação dos dados
library(data.table) # para transformação dos dados
library(janitor) # para transformação dos dados
library(ggplot2) # para visualização dos dados
# Carregar planilha montada a partir dos relatórios do IBGE Cidades
dt_municipios <- read_excel("Bases de dados/informacoes_municipios.xlsx")
setDT(dt_municipios)
# Renomear colunas
nomes <- c("id_municipio_nome", "sigla_uf", "IDHm", "PIBpc", "percentual_renda_pc_meio_sm", "taxa_escolarizacao", "pop", "densidade_demografica")
colnames(dt_municipios) <- nomes
rm(nomes)
# Transformar gentílico na sigla do UF
dt_municipios[, sigla_uf := fcase(
sigla_uf == "alagoano", "AL",
sigla_uf == "baiano", "BA",
sigla_uf == "cearense", "CE",
sigla_uf == "maranhense", "MA",
sigla_uf == "paraibano", "PB",
sigla_uf == "pernambucano", "PE",
sigla_uf == "piauiense", "PI",
sigla_uf == "potiguar, norte-rio-grandense, rio-grandense-do-norte", "RN",
sigla_uf == "sergipano ou sergipense", "SE"
)]
# Transformar pop e densidade demográfica em variáveis numéricas
dt_municipios[, pop := gsub("[^0-9.-]", "", pop) %>% as.numeric()]
dt_municipios[,
densidade_demografica := as.numeric(
gsub(",", ".", gsub("[^0-9,]", "", densidade_demografica))
)
]
# Fazer query
# query <- "SELECT
#     dados.ano AS ano,
#     dados.turno AS turno,
#     dados.sigla_uf AS sigla_uf,
#     diretorio_sigla_uf.nome AS sigla_uf_nome,
#     dados.id_municipio AS id_municipio,
#     diretorio_id_municipio.nome AS id_municipio_nome,
#     dados.cargo AS cargo,
#     dados.numero_partido AS numero_partido,
#     dados.sigla_partido AS sigla_partido,
#     dados.resultado AS resultado,
#     dados.votos AS votos
# FROM `basedosdados.br_tse_eleicoes.resultados_candidato_municipio` AS dados
# LEFT JOIN (
#     SELECT DISTINCT sigla, nome
#     FROM `basedosdados.br_bd_diretorios_brasil.uf`
# ) AS diretorio_sigla_uf
#     ON dados.sigla_uf = diretorio_sigla_uf.sigla
# LEFT JOIN (
#     SELECT DISTINCT id_municipio, nome
#     FROM `basedosdados.br_bd_diretorios_brasil.municipio`
# ) AS diretorio_id_municipio
#     ON dados.id_municipio = diretorio_id_municipio.id_municipio
# WHERE
#     dados.ano IN (2020)
#     AND dados.cargo = "prefeito"
#     AND CAST(dados.id_municipio AS STRING) LIKE "2%"
# "
# dt_eleicoes <- read_sql(query, billing_project_id = "pub-450900")
# setDT(dt_eleicoes)
# rm(query)
# Salvar base de dados resultante
# saveRDS(dt_eleicoes, "Bases de dados/informacoes_eleicoes.rds")
# Carregar base de dados de eleições
dt_eleicoes <- readRDS("Bases de dados/informacoes_eleicoes.rds")
setDT(dt_eleicoes)
# Retirar primeiro turno dos municípios que tiveram segundo turno
municipios_com_segundo_turno <- dt_eleicoes[turno == 2, unique(id_municipio)]
dt_eleicoes <- dt_eleicoes[!(turno == 1 &
id_municipio %in% municipios_com_segundo_turno)]
rm(municipios_com_segundo_turno)
# Selecionar os dois candidatos mais votados
setorder(dt_eleicoes, -votos)
dt_eleicoes <- dt_eleicoes[, head(.SD, 2), by = id_municipio]
# Definir razão de votos dos top 2 (contando somente os votos desses 2)
dt_eleicoes[, votos_total := sum(votos), by = id_municipio]
dt_eleicoes[, votos_razao := votos/votos_total]
# Retirar municípios em que nenhum dos dois primeiros colocados são do PP
municipios_com_candidato_pp <- dt_eleicoes[sigla_partido == "PP", unique(id_municipio)]
dt_eleicoes <- dt_eleicoes[id_municipio %in% municipios_com_candidato_pp]
rm(municipios_com_candidato_pp)
# Selecionar municípios em que a margem de vitória foi de 5% ou menos
dt_eleicoes <- dt_eleicoes[votos_razao >= 0.45 & votos_razao <= 0.55]
# Criar dummy que indica se o candidato do PP ganhou
municipios_com_vitoria_pp <- dt_eleicoes[sigla_partido == "PP" & resultado == "eleito",
unique(id_municipio)]
dt_eleicoes[, vitoria_pp := ifelse(id_municipio %in% municipios_com_vitoria_pp, 1, 0)]
rm(municipios_com_vitoria_pp)
# Selecionar só colunas e linhas relevantes
dt_eleicoes <- dt_eleicoes[
sigla_partido == "PP",
.(
id_municipio,
id_municipio_nome,
sigla_uf,
votos_razao,
vitoria_pp
)
]
setnames(dt_eleicoes, "votos_razao", "votos_razao_pp")
# Dar uma olhada na base de dados resultante
str(dt_eleicoes)
# Carregar base de dados de emendas parlamentares
dt_emendas <- read.csv2("Bases de dados/EmendasParlamentares.csv", fileEncoding = "Latin1", encoding = "UTF-8")
setDT(dt_emendas)
# Renomear colunas
colnames(dt_emendas) <- make_clean_names(colnames(dt_emendas))
setnames(dt_emendas, "codigo_municipio_ibge", "id_municipio")
# Selecionar dados relevantes
dt_emendas <- dt_emendas[
ano_da_emenda == 2021 & regiao == "Nordeste" & id_municipio != "Sem informação",
.(
ano_da_emenda,
tipo_de_emenda,
id_municipio,
valor_empenhado
)
]
# Ver quais tipos de emendas restam
dt_emendas[, unique(tipo_de_emenda)]
# Simplificar nome do tipo de emenda
dt_emendas[, tipo_de_emenda := fcase(
tipo_de_emenda == "Emenda Individual - Transferências com Finalidade Definida", "individual - finalidade definida",
tipo_de_emenda == "Emenda Individual - Transferências Especiais", "individual - 'pix'",
tipo_de_emenda == "Emenda de Bancada", "bancada",
tipo_de_emenda == "Emenda de Comissão", "comissão"
)]
# Agregar valor empenhado por ano, tipo de emenda e município
dt_emendas <- dt_emendas[, valor_empenhado := sum(valor_empenhado),
by = .(tipo_de_emenda, id_municipio)]
# Ver se algum município de dt_eleicoes não está em dt_municípios
municipios_dt_eleicoes <- unique(dt_eleicoes[, paste0(id_municipio_nome, sigla_uf)])
municipios_dt_municipios <- unique(dt_municipios[, paste0(id_municipio_nome, sigla_uf)])
for (muni in municipios_dt_eleicoes) {
if (!muni %in% municipios_dt_municipios) {
print(muni)
}
}
rm(municipios_dt_eleicoes, municipios_dt_municipios, muni)
# Renomear municípios de dt_municipios fora do padrão de dt_eleicoes
dt_municipios[id_municipio_nome == "Santa Terezinha" & sigla_uf == "BA",
id_municipio_nome := "Santa Teresinha"]
# Adicionar dados sobre os municípios com eleições de interesse
dt_municipios_eleicoes <- merge(dt_eleicoes, dt_municipios, all.x = T)
## Verificar se houve algum NA
colSums(is.na(dt_municipios_eleicoes))
# Criar dt com médias
medias_municipios_eleicoes <- dt_municipios_eleicoes[
,
.(
media_IDHm = mean(IDHm),
media_PIBpc = mean(PIBpc),
media_percentual_renda_pc_meio_sm = mean(percentual_renda_pc_meio_sm),
media_taxa_escolarizacao = mean(taxa_escolarizacao),
media_pop = mean(pop),
media_densidade_demografica = mean(densidade_demografica)
),
by = vitoria_pp
]
# Plotar médias de quem venceu vs. não venceu - formatar
medias_municipios_eleicoes %>%
ggplot(aes(y = media_IDHm, x = as.factor(vitoria_pp))) +
geom_col() +
theme_minimal()
medias_municipios_eleicoes %>%
ggplot(aes(y = media_PIBpc, x = as.factor(vitoria_pp))) +
geom_col() +
theme_minimal()
medias_municipios_eleicoes %>%
ggplot(aes(y = media_percentual_renda_pc_meio_sm, x = as.factor(vitoria_pp))) +
geom_col() +
theme_minimal()
medias_municipios_eleicoes %>%
ggplot(aes(y = media_taxa_escolarizacao, x = as.factor(vitoria_pp))) +
geom_col() +
theme_minimal()
medias_municipios_eleicoes %>%
ggplot(aes(y = media_pop, x = as.factor(vitoria_pp))) +
geom_col() +
theme_minimal()
medias_municipios_eleicoes %>%
ggplot(aes(y = media_densidade_demografica, x = as.factor(vitoria_pp))) +
geom_col() +
theme_minimal()
# Mostrar quais diferenças são estatisticamente significantes - fazer teste de comparação de médias
# Criar dt com médias
medianas_municipios_eleicoes <- dt_municipios_eleicoes[
,
.(
mediana_IDHm = median(IDHm),
mediana_PIBpc = median(PIBpc),
mediana_percentual_renda_pc_meio_sm = median(percentual_renda_pc_meio_sm),
mediana_taxa_escolarizacao = median(taxa_escolarizacao),
mediana_pop = median(pop),
mediana_densidade_demografica = median(densidade_demografica)
),
by = vitoria_pp
]
# Plotar médias de quem venceu vs. não venceu - formatar
medianas_municipios_eleicoes %>%
ggplot(aes(y = mediana_IDHm, x = as.factor(vitoria_pp))) +
geom_col() +
theme_minimal()
medianas_municipios_eleicoes %>%
ggplot(aes(y = mediana_PIBpc, x = as.factor(vitoria_pp))) +
geom_col() +
theme_minimal()
medianas_municipios_eleicoes %>%
ggplot(aes(y = mediana_percentual_renda_pc_meio_sm, x = as.factor(vitoria_pp))) +
geom_col() +
theme_minimal()
medianas_municipios_eleicoes %>%
ggplot(aes(y = mediana_taxa_escolarizacao, x = as.factor(vitoria_pp))) +
geom_col() +
theme_minimal()
medianas_municipios_eleicoes %>%
ggplot(aes(y = mediana_pop, x = as.factor(vitoria_pp))) +
geom_col() +
theme_minimal()
medianas_municipios_eleicoes %>%
ggplot(aes(y = mediana_densidade_demografica, x = as.factor(vitoria_pp))) +
geom_col() +
theme_minimal()
# Mostrar quais diferenças são estatisticamente significantes - fazer teste de comparação de médias
# Juntar bases de dados
## Somar todas as emendas por município
dt_emendas_total <- dt_emendas[,
.(valor_empenhado = sum(valor_empenhado)),
by = id_municipio]
## Juntar bases de dados
dt <- merge(dt_municipios_eleicoes, dt_emendas_total, by = "id_municipio", all.x = T)
## Verificar quantos NAs (municípios sem emendas) houve
colSums(is.na(dt))
munis_eleicoes_acirradas <- dt_municipios_eleicoes[, unique(id_municipio)]
munis_emendas <- dt_emendas[, unique(id_municipio)]
for (muni in munis_eleicoes_acirradas) {
if (muni %in% munis_emendas) {
print(muni)
}
}
munis_eleicoes_acirradas <- dt_municipios_eleicoes[, unique(id_municipio)]
munis_emendas <- dt_emendas[, unique(id_municipio)]
i <- 0
for (muni in munis_eleicoes_acirradas) {
if (muni %in% munis_emendas) {
i <- i+1
}
}
i
173+22
munis_eleicoes_acirradas <- dt_municipios_eleicoes[, unique(id_municipio)]
munis_emendas <- dt_emendas[, unique(id_municipio)]
i <- 0
for (muni in munis_emendas) {
if (muni %in% munis_eleicoes_acirradas) {
i <- i+1
}
}
i

---
title: "Trabalho de Avaliação de Políticas Sociais"
author: "Ana Di Nur, Gabriel Figueiredo, Tiago Brancher"
format: pdf
editor: visual
---

-   Diferença em relação à v1: Vou juntar dt_municipios_eleicoes com dt_emendas antes de cada exercício em vez de tentar juntar tudo no começo e ir alterando depois.
-   Diferença em relação à versão de 11.11.2025: Mudei os dados selecionados de características municipais (para serem mais recentes) e a fonte de dados de emendas parlamentares (para que o ano da emenda refletisse seu ano de empenho, não proposição)

# 0) Preparativos

```{r}
library(readxl) # para obtenção dos dados
library(basedosdados) # para obtenção dos dados
library(dplyr) # para transformação dos dados
library(data.table) # para transformação dos dados
library(janitor) # para transformação dos dados
library(ggplot2) # para visualização dos dados
```

# 1) Coleta de dados

## 1.1) Características municipais

-   Origem dos dados: Acessar [IBGE Cidades](https://cidades.ibge.gov.br/) \> Selecionar UFs do Nordeste \> Selecionar variáveis de interesse

    -   Hipótese: Perfil municipal não mudou significativamente entre os anos de coleta dos dados (2021, 2022) e o ano da eleição (2021)

    -   Variáveis selecionadas:

        -   População no último censo (2022)

        -   Densidade demográfica (2022)

        -   PIB *per capita* municipal (2021)

        -   Taxa de escolarização de 6 a 14 anos de idade (2022)

        -   Mortalidade infantil (2023)

```{r}
# Carregar planilha montada a partir dos relatórios do IBGE Cidades
dt_municipios <- read_excel("Bases de dados/IBGE_municipios.xlsx")
setDT(dt_municipios)

# Renomear colunas
nomes <- c("id_municipio_nome", "sigla_uf", "IDHm", "PIBpc", "percentual_renda_pc_meio_sm", "taxa_escolarizacao", "pop", "densidade_demografica")
colnames(dt_municipios) <- nomes
rm(nomes)

# Transformar gentílico na sigla do UF
dt_municipios[, sigla_uf := fcase(
  sigla_uf == "alagoano", "AL",
  sigla_uf == "baiano", "BA",
  sigla_uf == "cearense", "CE",
  sigla_uf == "maranhense", "MA",
  sigla_uf == "paraibano", "PB",
  sigla_uf == "pernambucano", "PE",
  sigla_uf == "piauiense", "PI",
  sigla_uf == "potiguar, norte-rio-grandense, rio-grandense-do-norte", "RN",
  sigla_uf == "sergipano ou sergipense", "SE"
)]

# Transformar pop e densidade demográfica em variáveis numéricas
dt_municipios[, pop := gsub("[^0-9.-]", "", pop) %>% as.numeric()]
dt_municipios[,
  densidade_demografica := as.numeric(
    gsub(",", ".", gsub("[^0-9,]", "", densidade_demografica))
  )
]
```

## 1.2) Eleições

-   Origem dos dados: Acessar [Base dos Dados \> Eleições Brasileiras](https://basedosdados.org/dataset/eef764df-bde8-4905-b115-6fc23b6ba9d6?table=391047eb-b3ef-4141-a4d1-725b29018f25){.uri} \> Resultados por Candidato e Município

```{r}
# Fazer query
# query <- "SELECT
#     dados.ano AS ano,
#     dados.turno AS turno,
#     dados.sigla_uf AS sigla_uf,
#     diretorio_sigla_uf.nome AS sigla_uf_nome,
#     dados.id_municipio AS id_municipio,
#     diretorio_id_municipio.nome AS id_municipio_nome,
#     dados.cargo AS cargo,
#     dados.numero_partido AS numero_partido,
#     dados.sigla_partido AS sigla_partido,
#     dados.resultado AS resultado,
#     dados.votos AS votos
# FROM `basedosdados.br_tse_eleicoes.resultados_candidato_municipio` AS dados
# LEFT JOIN (
#     SELECT DISTINCT sigla, nome  
#     FROM `basedosdados.br_bd_diretorios_brasil.uf`
# ) AS diretorio_sigla_uf
#     ON dados.sigla_uf = diretorio_sigla_uf.sigla
# LEFT JOIN (
#     SELECT DISTINCT id_municipio, nome  
#     FROM `basedosdados.br_bd_diretorios_brasil.municipio`
# ) AS diretorio_id_municipio
#     ON dados.id_municipio = diretorio_id_municipio.id_municipio
# WHERE 
#     dados.ano IN (2020)
#     AND dados.cargo = "prefeito"
#     AND CAST(dados.id_municipio AS STRING) LIKE "2%"
# "
# dt_eleicoes <- read_sql(query, billing_project_id = "pub-450900")
# setDT(dt_eleicoes)
# rm(query)

# Salvar base de dados resultante
# saveRDS(dt_eleicoes, "Bases de dados/TSE_eleicoes.rds")


# Carregar base de dados de eleições
dt_eleicoes <- readRDS("Bases de dados/TSE_eleicoes.rds")
setDT(dt_eleicoes)

# Retirar primeiro turno dos municípios que tiveram segundo turno
municipios_com_segundo_turno <- dt_eleicoes[turno == 2, unique(id_municipio)]
dt_eleicoes <- dt_eleicoes[!(turno == 1 &
                               id_municipio %in% municipios_com_segundo_turno)]
rm(municipios_com_segundo_turno)

# Selecionar os dois candidatos mais votados
setorder(dt_eleicoes, -votos)
dt_eleicoes <- dt_eleicoes[, head(.SD, 2), by = id_municipio]

# Definir razão de votos dos top 2 (contando somente os votos desses 2)
dt_eleicoes[, votos_total := sum(votos), by = id_municipio]
dt_eleicoes[, votos_razao := votos/votos_total]

# Retirar municípios em que nenhum dos dois primeiros colocados são do PP
municipios_com_candidato_pp <- dt_eleicoes[sigla_partido == "PP", unique(id_municipio)]
dt_eleicoes <- dt_eleicoes[id_municipio %in% municipios_com_candidato_pp]
rm(municipios_com_candidato_pp)

# Selecionar municípios em que a margem de vitória foi de 5% ou menos
dt_eleicoes <- dt_eleicoes[votos_razao >= 0.45 & votos_razao <= 0.55]

# Criar dummy que indica se o candidato do PP ganhou
municipios_com_vitoria_pp <- dt_eleicoes[sigla_partido == "PP" & resultado == "eleito",
                                         unique(id_municipio)]
dt_eleicoes[, vitoria_pp := ifelse(id_municipio %in% municipios_com_vitoria_pp, 1, 0)]
rm(municipios_com_vitoria_pp)

# Selecionar só colunas e linhas relevantes
dt_eleicoes <- dt_eleicoes[
  sigla_partido == "PP",
  .(
    id_municipio,
    id_municipio_nome,
    sigla_uf,
    votos_razao,
    vitoria_pp
  )
]
setnames(dt_eleicoes, "votos_razao", "votos_razao_pp")

# Dar uma olhada na base de dados resultante
str(dt_eleicoes)
```

-   Note que:

    -   Há 1794 municípios nordestinos

        -   1792 (99,9%) deles tiveram eleições municipais (Fernando de Noronha e \_\_\_\_\_\_, não)

            -   477 (26,6%) deles tiveram um candidato do PP entre os dois candidatos mais votados

                -   195 (40,6%) desses tiveram uma eleição acirrada (isto é, seu candidato eleito teve no máximo 55% dos votos)

                    -   Note que quase se atinge os 200 indicados como referência para a lei dos grandes números pela profa. Beti Kira nas aulas de Estatística!

## 1.3) Emendas parlamentares

-   Origem dos dados: [Portal da Transparência - CGU \> Emendas Parlamentares](https://portaldatransparencia.gov.br/download-de-dados/emendas-parlamentares)

```{r}
# Carregar base de dados de emendas parlamentares
dt_emendas <- read.csv2("Bases de dados/CGU_emendas_parlamentares.csv", fileEncoding = "Latin1", encoding = "UTF-8")
setDT(dt_emendas)

# Renomear colunas
colnames(dt_emendas) <- make_clean_names(colnames(dt_emendas))
setnames(dt_emendas, "codigo_municipio_ibge", "id_municipio")

# Selecionar dados relevantes
dt_emendas <- dt_emendas[
  ano_da_emenda == 2021 & regiao == "Nordeste" & id_municipio != "Sem informação",
  .(
     ano_da_emenda,
     tipo_de_emenda,
     id_municipio,
     valor_empenhado
  )
]

# Ver quais tipos de emendas restam
dt_emendas[, unique(tipo_de_emenda)]

# Simplificar nome do tipo de emenda
dt_emendas[, tipo_de_emenda := fcase(
  tipo_de_emenda == "Emenda Individual - Transferências com Finalidade Definida", "individual - finalidade definida",
  tipo_de_emenda == "Emenda Individual - Transferências Especiais", "individual - pix",
  tipo_de_emenda == "Emenda de Bancada", "bancada",
  tipo_de_emenda == "Emenda de Comissão", "comissão"
)]

# Agregar valor empenhado por ano, tipo de emenda e município
dt_emendas <- dt_emendas[,
                         valor_empenhado := sum(valor_empenhado),
                         by = .(tipo_de_emenda, id_municipio)]
```

-   Note que, após filtrar para 2021, região Nordeste e emendas direcionadas a certo município, não restam emendas de relator nem emendas de comissão. Por isso, não as analisaremos na estimação.

# 2) Estatísticas descritivas

## 2.1) Juntar bases de municípios e eleições

```{r}
# Ver se algum município de dt_eleicoes não está em dt_municípios
municipios_dt_eleicoes <- unique(dt_eleicoes[, paste0(id_municipio_nome, sigla_uf)])
municipios_dt_municipios <- unique(dt_municipios[, paste0(id_municipio_nome, sigla_uf)])
for (muni in municipios_dt_eleicoes) {
  if (!muni %in% municipios_dt_municipios) {
    print(muni)
  }
}
rm(municipios_dt_eleicoes, municipios_dt_municipios, muni)

# Renomear municípios de dt_municipios fora do padrão de dt_eleicoes
dt_municipios[id_municipio_nome == "Santa Terezinha" & sigla_uf == "BA",
              id_municipio_nome := "Santa Teresinha"]

# Adicionar dados sobre os municípios com eleições de interesse
dt_municipios_eleicoes <- merge(dt_eleicoes, dt_municipios, all.x = T)
## Verificar se houve algum NA
colSums(is.na(dt_municipios_eleicoes))
```

Agora, vamos mostrar que os municípios em que o candidato do PP ganhou vs. perdeu por pouco de fato são semelhantes.

## 2.1) Comparação de médias

```{r}
# Criar dt com médias
medias_municipios_eleicoes <- dt_municipios_eleicoes[
  ,
  .(
    media_IDHm = mean(IDHm),
    media_PIBpc = mean(PIBpc),
    media_percentual_renda_pc_meio_sm = mean(percentual_renda_pc_meio_sm),
    media_taxa_escolarizacao = mean(taxa_escolarizacao),
    media_pop = mean(pop),
    media_densidade_demografica = mean(densidade_demografica)
  ),
  by = vitoria_pp
]

# Plotar médias de quem venceu vs. não venceu - formatar
medias_municipios_eleicoes %>%
  ggplot(aes(y = media_IDHm, x = as.factor(vitoria_pp))) +
  geom_col() +
  theme_minimal()

medias_municipios_eleicoes %>%
  ggplot(aes(y = media_PIBpc, x = as.factor(vitoria_pp))) +
  geom_col() +
  theme_minimal()

medias_municipios_eleicoes %>%
  ggplot(aes(y = media_percentual_renda_pc_meio_sm, x = as.factor(vitoria_pp))) +
  geom_col() +
  theme_minimal()

medias_municipios_eleicoes %>%
  ggplot(aes(y = media_taxa_escolarizacao, x = as.factor(vitoria_pp))) +
  geom_col() +
  theme_minimal()

medias_municipios_eleicoes %>%
  ggplot(aes(y = media_pop, x = as.factor(vitoria_pp))) +
  geom_col() +
  theme_minimal()

medias_municipios_eleicoes %>%
  ggplot(aes(y = media_densidade_demografica, x = as.factor(vitoria_pp))) +
  geom_col() +
  theme_minimal()

# Mostrar quais diferenças são estatisticamente significantes - fazer teste de comparação de médias

```

-   As médias de população e densidade demográfica são bastante diferentes entre os dois grupos. Como elas são correlacionadas, é bastante provável que sejam algumas cidades grandes, outliers, puxando a média dos municípios com vitória do PP. Por isso, vamos usar a medida de mediana, que é menos sensível a valores extremos.

## 2.2) Comparação de medianas

```{r}
# Criar dt com médias
medianas_municipios_eleicoes <- dt_municipios_eleicoes[
  ,
  .(
    mediana_IDHm = median(IDHm),
    mediana_PIBpc = median(PIBpc),
    mediana_percentual_renda_pc_meio_sm = median(percentual_renda_pc_meio_sm),
    mediana_taxa_escolarizacao = median(taxa_escolarizacao),
    mediana_pop = median(pop),
    mediana_densidade_demografica = median(densidade_demografica)
  ),
  by = vitoria_pp
]

# Plotar médias de quem venceu vs. não venceu - formatar
medianas_municipios_eleicoes %>%
  ggplot(aes(y = mediana_IDHm, x = as.factor(vitoria_pp))) +
  geom_col() +
  theme_minimal()

medianas_municipios_eleicoes %>%
  ggplot(aes(y = mediana_PIBpc, x = as.factor(vitoria_pp))) +
  geom_col() +
  theme_minimal()

medianas_municipios_eleicoes %>%
  ggplot(aes(y = mediana_percentual_renda_pc_meio_sm, x = as.factor(vitoria_pp))) +
  geom_col() +
  theme_minimal()

medianas_municipios_eleicoes %>%
  ggplot(aes(y = mediana_taxa_escolarizacao, x = as.factor(vitoria_pp))) +
  geom_col() +
  theme_minimal()

medianas_municipios_eleicoes %>%
  ggplot(aes(y = mediana_pop, x = as.factor(vitoria_pp))) +
  geom_col() +
  theme_minimal()

medianas_municipios_eleicoes %>%
  ggplot(aes(y = mediana_densidade_demografica, x = as.factor(vitoria_pp))) +
  geom_col() +
  theme_minimal()

# Mostrar quais diferenças são estatisticamente significantes - fazer teste de comparação de médias

```

-   De fato, usando a mediana, população e densidade demográfica ficaram mais parecidas. O PIBpc ficou um pouco menos parecido, mas, no todo, parece bastante razoável.

    -   DÚVIDA: COMO PARECE HAVER MUNICÍPIOS OUTLIERS, DEVERÍAMOS TIRÁ-LOS DA AMOSTRA?

# 3) Estimação

Para cada análise (todas as emendas vs. emendas individuais vs. emendas de bancada etc.), vamos juntar as bases de dados (dt_municipios_eleicoes e dt_emendas) e, então, visualizar e estimar o valor adicional recebido via emendas parlamentares pelos municípios em que o candidato a prefeito do PP ganhou por pouco.

## 3.1) Para todos os tipos de emendas

```{r}
# Juntar bases de dados
## Somar todas as emendas por município
dt_emendas_total <- dt_emendas[,
                               .(valor_empenhado = sum(valor_empenhado)),
                               by = id_municipio]
## Juntar bases de dados
dt <- merge(dt_municipios_eleicoes, dt_emendas_total, by = "id_municipio", all.x = T)
## Verificar quantos NAs (municípios sem emendas) houve
colSums(is.na(dt))
## Preencher valores NA com 0


# Checar base de dados
str(dt_todas)

# Plotar diferença

# Fazer a estimação

```

-   DÚVIDA: 173 de 195 NÃO TEREM RECEBIDO QUALQUER EMENDA PARECE ALTO DEMAIS! CONFERIR COM NOMES DE MUNICÍPIOS, SIGA BRASIL

## 3.2) Para emendas individuais (inclusive Pix)

```{r}
# Filtrar por tipo de emenda
# tipo_emenda %in% c("individual - finalidade definida", "individual - 'pix"),

# Checar base de dados
str(dt_individual_inclusive_pix)

# Plotar diferença

# Fazer a estimação

```

## 3.3) Para emendas individuais (exceto Pix)

```{r}
# Filtrar por tipo de emenda
dt_individual_sem_pix <- dt[tipo_de_emenda == "individual - finalidade definida"]

# Checar base de dados
str(dt_individual_sem_pix)

# Plotar diferença

# Fazer a estimação

```

## 3.4) Para emendas individuais (somente Pix)

```{r}
# Filtrar por tipo de emenda
dt_individual_somente_pix <- dt[tipo_de_emenda == "individual - pix"]

# Checar base de dados
str(dt_individual_somente_pix)

# Plotar diferença

# Fazer a estimação

```

## 3.5) Para emendas de bancada

```{r}
# Filtrar por tipo de emenda
dt_bancada <- dt[tipo_de_emenda == "bancada"]
dt_bancada <- unique(dt_bancada)

# Checar base de dados
str(dt_bancada)

# Plotar diferença

# Fazer a estimação

```

# 4) Teste de robustez

-   Repetir a estimação para anos anteriores a 2021, mostrando que não dá efeito (se tudo der certo)

```{r}

```
